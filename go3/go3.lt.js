var bundlesLt = [
    {
        id: 989311,
        title: 'TV ir sportas',
        price: '9.99 €',
        description: [
            { title: 'Daugiau nei 35 lietuviškų ir užsienietiškų TV kanalų' },
            { title: 'TV3 sport, Setanta, NBA TV' },
            { title: 'Tiesioginės transliacijos' },
            { title: 'Sporto dokumentika' },
            { title: 'Archyvas iki 7 d.' },
        ],
        subscribe: 'Prenumeruoti',
    },
    {
        id: 989321,
        title: 'Filmai',
        price: '6.99 €',
        includes: 'Įtrauktas Paramount+ ir Go3 originalus turinys',
        description: [
            { title: 'Paramount+: Paramount Pictures filmai, CBS/ShowTime serialai, Comedy Central, Nickelodeon animacija, MTV realybės šou ir dar daugiau' },
            { title: 'Go3 originalus turinys' },
            { title: 'Disney filmai' },
            { title: 'Populiarūs filmų kanalai' },
            { title: 'Naujausi filmai ir serialai' },
            { title: 'Turinys vaikams' },
            { title: 'Lietuviškos laidos pasirodo anksčiau nei per TV' },
        ],
        subscribe: 'Prenumeruoti',
    },
    {
        id: 2935376,
        title: 'Filmai',
        price: '6.99 €',
        includes: 'Įtrauktas Paramount+ ir Go3 originalus turinys',
        plus: ['& discovery+'],
        description: [
            { title: 'Paramount+: Paramount Pictures filmai, CBS/ShowTime serialai, Comedy Central, Nickelodeon animacija, MTV realybės šou ir dar daugiau' },
            { title: 'Go3 originalus turinys' },
            { title: 'Disney filmai' },
            { title: 'Populiarūs filmų kanalai' },
            { title: 'Naujausi filmai ir serialai' },
            { title: 'Turinys vaikams' },
            { title: 'Lietuviškos laidos pasirodo anksčiau nei per TV' },
        ],
        subscribe: 'Prenumeruoti',
    },
    {
        id: 989319,
        title: 'TV',
        price: '7.99 €',
        description: [{ title: 'Archyvas iki 7 d.' }, { title: 'Daugiau nei 25 lietuviški ir užsienietiški TV kanalai' }],
        subscribe: 'Prenumeruoti',
    },
    {
        id: 989317,
        title: 'Sports',
        price: '6.99 €',
        description: [{ title: 'TV3 sport, Setanta, NBA TV' }, { title: 'Tiesioginės transliacijos' }, { title: 'Sporto dokumentika' }],
        subscribe: 'Prenumeruoti',
    },
];

var bundlesEn = [
    {
        id: 989311,
        title: 'TV and Sports',
        price: '9.99 €',
        description: [
            { title: 'More than 30 local and foreign TV channels' },
            { title: 'TV3 sport, Setanta, NBA TV' },
            { title: 'Live stream for events' },
            { title: 'Sport documentaries' },
            { title: 'Up to 7 day catch-up' },
        ],
        subscribe: 'Subscribe',
    },
    {
        id: 989321,
        title: 'Films',
        price: '6.99 €',
        includes: 'Includes Paramount+ & Go3 Originals',
        description: [
            { title: 'Paramount+: Paramount Pictures movies, CBS/ShowTime TV series, Comedy Central, Nickelodeon animation, MTV reality shows and more' },
            { title: 'Go3 originals' },
            { title: 'Disney blockbusters' },
            { title: 'Premium channels for movies' },
            { title: 'Latest movies & series' },
            { title: 'Kids content' },
            { title: 'Early access to local shows' },
        ],
        subscribe: 'Subscribe',
    },
    {
        id: 2935376,
        title: 'Films',
        price: '9.98 €',
        includes: 'Includes Paramount+ & Go3 Originals',
        plus: ['& discovery+'],
        description: [
            { title: 'Paramount+: Paramount Pictures movies, CBS/ShowTime TV series, Comedy Central, Nickelodeon animation, MTV reality shows and more' },
            { title: 'Go3 originals' },
            { title: 'Disney blockbusters' },
            { title: 'Premium channels for movies' },
            { title: 'Latest movies & series' },
            { title: 'Kids content' },
            { title: 'Early access to local shows' },
        ],
        subscribe: 'Subscribe',
    },
    {
        id: 989319,
        title: 'TV',
        price: '7.99 €',
        description: [{ title: '7 day catch-up' }, { title: 'More than 30 local and foreign TV channels' }],
        subscribe: 'Subscribe',
    },

    {
        id: 989317,
        title: 'Sports',
        price: '6.99 €',
        description: [{ title: 'TV3 sport, Setanta, NBA TV' }, { title: 'Live streams for events' }, { title: 'Sports documentaries' }],
        addons: [{ 2935377: '& discovery+' }, { 2218494: '& Turinys suaugusiems' }, { 3411405: '& NBA' }],
        subscribe: 'Subscribe',
    },
];

var bundlesRu = [
    {
        id: 989311,
        title: 'ТВ и спорт',
        price: '9.99 €',
        description: [
            { title: 'Более 30 местных и зарубежных каналов' },
            { title: 'TV3 sport, Setanta, NBA TV' },
            { title: 'Прямые трансляции' },
            { title: 'Спортивные документальные фильмы' },
            { title: 'Архив до 7 дней' },
        ],
        subscribe: 'Подписаться',
    },
    {
        id: 989321,
        title: 'Фильмы',
        price: '6.99 €',
        includes: 'Включает Paramount+, Оригиналы Go3',
        description: [
            { title: 'Paramount +: Фильмы Paramount Pictures, сериалы CBS / ShowTime, Comedy Central, анимация Nickelodeon, реалити-шоу MTV и многое другое' },
            { title: 'Включает Оригиналы Go3' },
            { title: 'Фильмы Disney' },
            { title: 'Лучшие ТВ каналы фильмов' },
            { title: 'Новые фильмы и сериалы' },
            { title: 'Содержание для детей' },
            { title: 'Местные сериалы и шоу раньше, чем на ТВ' },
        ],
        subscribe: 'Подписаться',
    },
    {
        id: 2935376,
        title: 'Фильмы',
        price: '6.99 €',
        includes: 'Включает Paramount+, Оригиналы Go3',
        plus: ['& discovery+'],
        description: [
            { title: 'Paramount +: Фильмы Paramount Pictures, сериалы CBS / ShowTime, Comedy Central, анимация Nickelodeon, реалити-шоу MTV и многое другое' },
            { title: 'Включает Оригиналы Go3' },
            { title: 'Фильмы Disney' },
            { title: 'Лучшие ТВ каналы фильмов' },
            { title: 'Новые фильмы и сериалы' },
            { title: 'Содержание для детей' },
            { title: 'Местные сериалы и шоу раньше, чем на ТВ' },
        ],
        subscribe: 'Подписаться',
    },
    {
        id: 989319,
        title: 'ТВ',
        price: '7.99 €',
        description: [{ title: 'Архив до 7 дней' }, { title: 'Более 30 местных и зарубежных каналов' }],
        subscribe: 'Подписаться',
    },

    {
        id: 989317,
        title: 'Спорт',
        price: '6.99 €',
        description: [{ title: 'TV3 sport, Setanta, NBA TV' }, { title: 'Прямые трансляции' }, { title: 'Спортивные документальные фильмы' }],
        subscribe: 'Подписаться',
    },
];

var setButtonText = function () {
    if (localStorage.getItem('language') == '"LT"') {
        return 'ŽIŪRĖTI';
    } else if (localStorage.getItem('language') == '"EN"') {
        return 'WATCH';
    } else if (localStorage.getItem('language') == '"RU"') {
        return 'СМОТРЕТЬ';
    }
};

function setCookie(name, value, days) {
    var expires = '';
    if (days) {
        var date = new Date();
        date.setTime(date.getTime() + days * 24 * 60 * 60 * 1000);
        expires = '; expires=' + date.toUTCString();
    }
    document.cookie = name + '=' + (value || '') + expires + '; path=/';
}
function getCookie(name) {
    var nameEQ = name + '=';
    var ca = document.cookie.split(';');
    for (var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) == ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
    }
    return null;
}

setCookie('new-user', true, 90);

var getJSON = function (url, callback) {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', url, true);
    xhr.responseType = 'json';
    xhr.onload = function () {
        var status = xhr.status;
        if (status === 200) {
            callback(null, xhr.response);
        } else {
            callback(status, xhr.response);
        }
    };
    xhr.send();
};

var pageBundleId;

var getProductBundleIds = function () {
    var pageUrl = window.location.href;

    var mediaId = pageUrl.match(/\d+/g)[pageUrl.match(/\d+/g).length - 1];

    var serialPage = pageUrl.match(/\bserial\b/);
    var videoPage = pageUrl.match(/\bvod\b/);
    var livePage = pageUrl.match(/\blive\b/);
    var url;

    if (serialPage) {
        var serialId = pageUrl.match(/\bserial-\b.[0-9]+/)[0];
        var extractedNumbersFormSeries = serialId.match(/[0-9]+/);
        url = 'https://go3.lt/api/products/vods/serials/' + extractedNumbersFormSeries + '?platform=BROWSER&lang=EN&tenant=AMB_LT';
    }

    if (videoPage) {
        url = 'https://go3.lt/api/products/vods/' + mediaId + '?platform=BROWSER&lang=EN&tenant=AMB_LT';
    }

    if (livePage) {
        var liveTvMediaId = pageUrl.match(/\blive-\b.[0-9]+/)[0];
        var extractedNumbers = liveTvMediaId.match(/[0-9]+/);
        url = 'https://go3.lt/api/products/lives/' + extractedNumbers + '?platform=BROWSER&lang=EN&tenant=AMB_LT';
    }

    getJSON(url, function (err, data) {
        if (err !== null) {
            console.table('Something went wrong: ' + err);
        } else {
            var bundles = data.bundles;
            var bundleIds = [];

            for (i = 0; i < bundles.length; i++) {
                if (i != bundles.length - 1) {
                    bundleIds += bundles[i].id + ',';
                } else {
                    bundleIds += bundles[i].id;
                }
            }
            console.table(bundles);
            pageBundleId = bundleIds;
            localStorage.setItem('bundleIds', '[' + data.bundles[0].id + ']');
        }
    });
};

var generateModal = function () {
    pageBundleId = '';
    getProductBundleIds();

    var interval = window.setInterval(function () {
        var bundlesByLanguage;

        if (localStorage.getItem('language') == '"LT"') {
            bundlesByLanguage = bundlesLt;
        } else if (localStorage.getItem('language') == '"EN"') {
            bundlesByLanguage = bundlesEn;
        } else if (localStorage.getItem('language') == '"RU"') {
            bundlesByLanguage = bundlesRu;
        }

        if (pageBundleId && !document.querySelector('.ab-test-modal')) {
            clearInterval(interval);

            var filteredBundles = [];
            var splittedPageBundleIds = pageBundleId.split(',');

            for (let index = 0; index < splittedPageBundleIds.length; index++) {
                const splittedBundleId = splittedPageBundleIds[index];

                for (let index = 0; index < bundlesByLanguage.length; index++) {
                    const bundleId = bundlesByLanguage[index];

                    if (splittedBundleId == bundleId.id) {
                        filteredBundles.push(bundleId);
                        break;
                    }
                }
            }

            if (!filteredBundles.length) {
                filteredBundles[0] = bundlesByLanguage[2];
            }

            var includes = filteredBundles[0].includes && filteredBundles[0].includes;
            var title = filteredBundles[0].title;
            var plus = filteredBundles[0].plus && filteredBundles[0].plus;
            var price = filteredBundles[0].price;
            var description = filteredBundles[0].description;
            var subscribe = filteredBundles[0].subscribe;

            var modal = document.createElement('div');
            modal.setAttribute('class', 'ab-test-modal');
            modal.innerHTML =
                '<div class="modal-overflow"></div><div class="modal-inner"> ' +
                (!!includes ? '<div class="modal-includes">' + includes + '</div>' : '') +
                ' <div class="modal-close"></div><div class="modal-recommended">RECOMMENDED PLAN</div>' +
                '<div class="modal-title">' +
                title +
                '</div>' +
                (!!plus ? '<div class="modal-plus">' + plus + '</div>' : '') +
                '<div class="modal-price">' +
                price +
                '<span class="modal-price-month"> / month</span>' +
                '</div>' +
                '<div class="c-feature__column"></div>' +
                '<button class="o-button o-button--primary modal-subscribe-button"> <span class="o-typography__label o-button__label u-bold"> ' +
                subscribe +
                ' </span> </button>';

            document.querySelector('body').append(modal);
            var modalList = document.querySelector('.ab-test-modal .c-feature__column');

            description.forEach(function (item) {
                modalList.innerHTML +=
                    "<div class='c-feature__item'><i class='o-icon c-feature__icon u-color-accent o-icon--check'></i><span class='o-typography__subtitle3 c-feature__label'>" +
                    item.title +
                    '</span></div>';
            });

            var modalCloseButton = document.querySelector('.modal-close');
            var modalOverflow = document.querySelector('.modal-close, .modal-overflow ');
            var modalSubscribeButton = document.querySelector('.modal-subscribe-button');

            modalCloseButton.addEventListener('click', function () {
                document.querySelector('.ab-test-modal').remove();
            });

            modalOverflow.addEventListener('click', function () {
                document.querySelector('.ab-test-modal').remove();
            });

            modalSubscribeButton.addEventListener('click', function () {
                document.querySelector('.ab-test-modal').remove();
                window.location = 'https://go3.lt/subscriber/checkout';
            });

            var contentUrl = window.location.href;

            var modalInterval = window.setInterval(function () {
                if (contentUrl != window.location.href) {
                    clearInterval(modalInterval);
                    document.querySelector('.ab-test-modal').remove();
                }
            }, 1000);
        }
    }, 200);
};

setInterval(() => {
    if (window.location.href.indexOf('movies') > -1 || window.location.href.indexOf('paramount') > -1) {
        var buttonContainer = document.querySelector(' div.c-highlight__wrapper > div.c-highlight__buttons ');
        if (buttonContainer && !document.querySelector('.changed-button')) {
            buttonContainer.classList.add('changed-button');
            if (
                buttonContainer.querySelector('.o-button--primary') &&
                (buttonContainer.querySelector('.o-button--primary').textContent.includes('BUY') ||
                    buttonContainer.querySelector('.o-button--primary').textContent.includes('PIRKTI') ||
                    buttonContainer.querySelector('.o-button--primary').textContent.includes('КУПИТЬ'))
            ) {
                buttonContainer.querySelector('.o-button--primary').remove();

                var newButton = document.createElement('div');
                newButton.setAttribute('class', 'o-button o-button--primary ab-test-button');
                newButton.innerHTML = setButtonText() + ' <div class="arrow-right"></div>';

                buttonContainer.prepend(newButton);
                var newAddedButton = document.querySelector('.ab-test-button');

                newAddedButton.addEventListener('click', function () {
                    getProductBundleIds();
                    generateModal();
                });
            }
        }
    }
}, 500);

setInterval(() => {
    if (
        window.location.href.indexOf('serial') > -1 ||
        window.location.href.indexOf('go3_extra') > -1 ||
        window.location.href.indexOf('ghost') > -1 ||
        window.location.href.indexOf('paramount') > -1 ||
        window.location.href.indexOf('discoveryplus') > -1
    ) {
        var buttonContainer = document.querySelector(' div.c-highlight__wrapper > div.c-highlight__buttons ');
        if (
            !document.querySelector('div.c-highlight__buttons > div:nth-child(1) > i.o-icon--play') &&
            buttonContainer &&
            !document.querySelector('.changed-button')
        ) {
            buttonContainer.classList.add('changed-button');

            var newButton = document.createElement('div');
            newButton.setAttribute('class', 'o-button o-button--primary ab-test-button');
            newButton.innerHTML = setButtonText() + ' <div class="arrow-right"></div>';

            buttonContainer.prepend(newButton);
            buttonContainer.querySelector('.ab-test-button').addEventListener('click', function () {
                getProductBundleIds();
                generateModal();
            });
            document.querySelector('div.c-highlight__buttons.changed-button > div:nth-child(2)').remove();
        }
        var additionalSeriesBlocks = document.querySelectorAll(
            '#app > div.app-container > div > section.c-section.c-section--two-lines > div > div.c-section__container.js-section-container > div.c-section__wrapper > div'
        );

        if (additionalSeriesBlocks) {
            var seriesButton = document.createElement('div');
            seriesButton.setAttribute('class', 'ab-test-button');
            seriesButton.innerHTML = '<div class="arrow-right"></div>';

            setInterval(() => {
                document
                    .querySelectorAll(
                        '#app > div.app-container > div > section.c-section.c-section--two-lines > div > div.c-section__container.js-section-container > div.c-section__wrapper > div'
                    )
                    .forEach(function (block) {
                        if (!block.querySelector('.ab-test-button') && !block.querySelector('i.o-icon.o-button__icon.o-icon--play-circle.o-icon--xlarge')) {
                            block.prepend(seriesButton.cloneNode(true));
                            block.querySelector('.ab-test-button').addEventListener('click', function () {
                                getProductBundleIds();
                                generateModal();
                            });
                        }
                    });
            }, 1000);
        }
    }
}, 500);

// Interval for live tv

setInterval(() => {
    if (window.location.href.indexOf('live_tv') > -1) {
        var buttonContainer = document.querySelectorAll('div.c-live-detail__preview.c-live-detail__preview--channel > div.c-live-detail__cover.u-desktop-only');
        var buttonContainerMobile = document.querySelectorAll('a.is-selected.js-current-program > div.c-epg-program-detail.u-mobile-only > div');

        if (buttonContainer) {
            var newButton = document.createElement('div');
            newButton.setAttribute('class', 'o-button o-button--primary ab-test-button');
            newButton.innerHTML = setButtonText() + ' <div class="arrow-right"></div>';

            buttonContainer.forEach(function (container) {
                if (!container.querySelector('ab-test-button-button')) {
                    container.prepend(newButton);

                    container.querySelector('.ab-test-button').addEventListener('click', function () {
                        getProductBundleIds();
                        generateModal();
                    });
                }
            });

            buttonContainerMobile.forEach(function (container) {
                if (!container.querySelector('ab-test-button-button')) {
                    container.prepend(newButton.cloneNode(true));

                    container.querySelector('.ab-test-button').addEventListener('click', function () {
                        getProductBundleIds();
                        generateModal();
                    });
                }
            });
        }
    }
}, 500);
